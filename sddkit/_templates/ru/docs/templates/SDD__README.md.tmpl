# SDD в этом репозитории (Spec Kit + sdd-kit overlay)

> Tooling: `sdd-workflow-kit {{kit_version}}`

Этот репозиторий использует Spec-Driven Development (SDD) в гибридном режиме:

- **SDD ядро**: GitHub **Spec Kit** (markdown пайплайн `spec.md → plan.md → tasks.md → implement`)
- **Overlay**: `sdd-kit` (ставит/пинит инфраструктуру, делает drift-check managed файлов, добавляет опциональные скэффолды)

## TL;DR

### Разработчику (ежедневная работа)

1. Создать фичу: `speckit.specify` (или скрипт `.specify/scripts/.../create-new-feature.*`)
2. План: `speckit.plan`
3. Задачи: `speckit.tasks`
4. Реализация: `speckit.implement`
5. Перед PR: `python3 .tooling/sdd-workflow-kit/bin/sdd-kit check --project .`

### Админу (развертывание и обновления)

1. Подтянуть submodules: `git submodule update --init --recursive`
2. Синхронизировать managed файлы: `python3 .tooling/sdd-workflow-kit/bin/sdd-kit sync --project .`
3. Проверить дрейф: `python3 .tooling/sdd-workflow-kit/bin/sdd-kit check --project .`
4. Обновление toolchain: обновить submodule `.tooling/sdd-workflow-kit` на новый тег, затем `sync` + `check`

## Что это и зачем

Задача системы: сделать процесс разработки воспроизводимым.

- Spec Kit задает **единый SDD цикл** для новых фич.
- `sdd-kit` гарантирует, что инфраструктура Spec Kit (скрипты/шаблоны/промпты) **прибита к версии** и **проверяется на дрейф**.

Ключевая идея: мы не пытаемся «управлять всем репозиторием». Управляются только выбранные файлы и только в безопасном режиме.

## Как это работает (схема)

```mermaid
flowchart LR
  KIT["sdd-workflow-kit (git submodule)"] --> SYNC["sdd-kit sync"]
  SYNC --> SPECIFY[".specify/* (Spec Kit scripts + templates)"]
  SYNC --> PROMPTS[".codex/prompts/speckit.*.md"]
  SYNC --> FRAG[".sddkit/fragments/AGENTS.manual.md"]

  DEV["Developer / agent"] --> SPK["speckit.specify/plan/tasks/implement"]
  SPK --> SPECIFY
  SPK --> SPECS["specs/###-feature/{spec,plan,tasks}.md"]

  SPECIFY --> AG["AGENTS.md (Spec Kit updater)"]
  FRAG --> AG

  CHECK["sdd-kit check (CI/local gate)"] --> SPECIFY
  CHECK --> PROMPTS
  CHECK --> AG
```

## Где что лежит (структура)

```text
.sddkit/
  config.toml                  # настройки sdd-kit (ручные)
  fragments/
    AGENTS.manual.md           # overlay для MANUAL-блока в AGENTS.md (редактируй это)

.specify/                      # managed: Spec Kit templates/scripts (ставит sdd-kit)
  templates/                   # шаблоны: spec/plan/tasks/...
  scripts/
    bash/                      # sh-скрипты (mac/linux)
    powershell/                # ps-скрипты (windows)
  memory/
    constitution.md            # принципы/конституция (создается если нет; можно править руками)
  THIRD_PARTY_NOTICES.md       # managed: лицензии/атрибуция upstream Spec Kit

.codex/prompts/                # managed: команды для Codex (speckit.*)
  speckit.specify.md
  speckit.plan.md
  speckit.tasks.md
  speckit.implement.md

specs/                         # NOT managed: артефакты фич (создает Spec Kit)
  001-feature-name/
    spec.md
    plan.md
    tasks.md
```

## Что кем управляется (ownership + drift-check)

- `.specify/templates/*`: управляет `sdd-kit` (копируется из pinned Spec Kit). `check` проверяет дрейф.
- `.specify/scripts/*`: управляет `sdd-kit`. `check` проверяет дрейф.
- `.codex/prompts/speckit.*.md`: управляет `sdd-kit` (генерируется из pinned Spec Kit). `check` проверяет дрейф.
- `.specify/memory/constitution.md`: **вы**. `sdd-kit` только создает файл, если его нет, и дальше не трогает.
- `specs/**`: создается/редактируется в рамках фичи. `sdd-kit` не проверяет содержимое.
- `AGENTS.md`: обновляется Spec Kit (`update-agent-context.*`). `sdd-kit` управляет только MANUAL-блоком.

### Важно про `AGENTS.md`

Редактируйте локальные добавки только через:

- `.sddkit/fragments/AGENTS.manual.md`

`sync` патчит только блок:

```text
<!-- MANUAL ADDITIONS START -->
...
<!-- MANUAL ADDITIONS END -->
```

Так Spec Kit и overlay не конфликтуют.

## Как пользоваться (разработчику, по шагам)

### 0) После `git clone`

Если в репозитории есть submodules:

```bash
git submodule update --init --recursive
```

### 1) Создать фичу

Рекомендуемый путь: команда агента `speckit.specify`.

Если нужно без агента:

```bash
bash .specify/scripts/bash/create-new-feature.sh "Короткое описание фичи"
```

Результат:

- создаст ветку вида `001-feature-name`
- создаст `specs/001-feature-name/spec.md`

### 2) Сделать план

Рекомендуемый путь: `speckit.plan`.

Без агента:

```bash
bash .specify/scripts/bash/setup-plan.sh
```

Результат:

- создаст/обновит `specs/001-.../plan.md`
- (обычно) обновит `AGENTS.md` через `update-agent-context`

### 3) Разбить на задачи

Команда: `speckit.tasks`.

Результат:

- создаст/обновит `specs/001-.../tasks.md`

### 4) Реализовать задачи

Команда: `speckit.implement`.

Практика, чтобы не «уплывать» от спека:

- Делайте задачи по одной (малые диффы).
- После каждой логической группы запускайте реальные проверки (тесты/линт/сборка).
- Если меняются требования: сначала обновите `spec.md/plan.md/tasks.md`, потом меняйте код.

### 5) Перед PR: проверить дрейф managed-файлов

```bash
python3 .tooling/sdd-workflow-kit/bin/sdd-kit check --project .
```

Если есть `DRIFT/MISSING`:

```bash
python3 .tooling/sdd-workflow-kit/bin/sdd-kit sync --project .
python3 .tooling/sdd-workflow-kit/bin/sdd-kit check --project .
```

## Админу: развертывание и поддержка

### Базовые команды

- `bootstrap`: создать `.sddkit/config.toml` (если нет) и сразу выполнить `sync`
- `sync`: привести managed-файлы к ожидаемому состоянию
- `check`: проверить, что проект не «уплыл» (удобно для CI)

### Safe mode (почему kit «не ломает» репозиторий)

По умолчанию включен `safe_mode = true`.

Это значит:

- kit пишет и обновляет только файлы, которые сам пометил как managed
- если файл уже существует, но он не managed, kit его **пропустит** (и покажет `UNMANAGED` в плане/проверке)

### CI: drift-check (GitHub Actions)

Критично для Spec Kit mode: checkout должен быть с `submodules: recursive`.

Обычно в CI запускают:

```bash
python3 .tooling/sdd-workflow-kit/bin/sdd-kit check --project . --config .sddkit/config.toml
```

### Обновление `sdd-workflow-kit` в этом репозитории

Рекомендованный процесс:

1. Обновить submodule `.tooling/sdd-workflow-kit` на новый тег.
2. `git submodule update --init --recursive`
3. `sync` и `check`
4. Закоммитить: обновление submodule + измененные managed-файлы.

### Включить Memory Bank (опционально)

Memory Bank можно включить параллельно со Spec Kit, это не конфликтует.

В `.sddkit/config.toml`:

```toml
[manage]
memory_bank = true
meta_tools = true
meta_sdd = true
```

Затем:

```bash
python3 .tooling/sdd-workflow-kit/bin/sdd-kit sync --project .
```

## Troubleshooting

### `UNMANAGED ... (safe_mode)`

Значит файл уже существует и не помечен как managed.

Варианты:

- переименовать/удалить файл и снова `sync`
- отключить управление этим файлом в `[manage]`

### Spec Kit ругается на ветку

Spec Kit ожидает ветки вида `001-feature-name`. Создавайте фичи через `speckit.specify`.

### Windows

Если репозиторий в Windows, используйте `script_variant = "ps"` в `.sddkit/config.toml` и синхронизируйте.
