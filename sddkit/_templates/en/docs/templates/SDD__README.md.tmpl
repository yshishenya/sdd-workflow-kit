# SDD in This Repo (Spec Kit + sdd-kit overlay)

> Tooling: `sdd-workflow-kit {{kit_version}}`

This repository uses Spec-Driven Development (SDD) in a hybrid mode:

- **SDD core**: GitHub **Spec Kit** (markdown pipeline `spec.md → plan.md → tasks.md → implement`)
- **Overlay**: `sdd-kit` (installs/pins infrastructure, drift-checks managed files, optional scaffolds)

## TL;DR

### For developers (daily loop)

1. Create a feature: `speckit.specify` (or `.specify/scripts/.../create-new-feature.*`)
2. Plan: `speckit.plan`
3. Tasks: `speckit.tasks`
4. Implement: `speckit.implement`
5. Before PR: `python3 .tooling/sdd-workflow-kit/bin/sdd-kit check --project .`

### For repo admins (setup + updates)

1. Pull submodules: `git submodule update --init --recursive`
2. Sync managed files: `python3 .tooling/sdd-workflow-kit/bin/sdd-kit sync --project .`
3. Drift gate: `python3 .tooling/sdd-workflow-kit/bin/sdd-kit check --project .`
4. Toolchain updates: bump `.tooling/sdd-workflow-kit` to a new tag, then `sync` + `check`

## What This Is (and Why)

Goal: make the workflow reproducible.

- Spec Kit defines the **single SDD loop** for new features.
- `sdd-kit` makes the Spec Kit infrastructure **pinned** and **drift-checkable**.

We intentionally do not “own the whole repo”. Only selected managed files are enforced.

## How It Works (Diagram)

```mermaid
flowchart LR
  KIT["sdd-workflow-kit (git submodule)"] --> SYNC["sdd-kit sync"]
  SYNC --> SPECIFY[".specify/* (Spec Kit scripts + templates)"]
  SYNC --> PROMPTS[".codex/prompts/speckit.*.md"]
  SYNC --> FRAG[".sddkit/fragments/AGENTS.manual.md"]

  DEV["Developer / agent"] --> SPK["speckit.specify/plan/tasks/implement"]
  SPK --> SPECIFY
  SPK --> SPECS["specs/###-feature/{spec,plan,tasks}.md"]

  SPECIFY --> AG["AGENTS.md (Spec Kit updater)"]
  FRAG --> AG

  CHECK["sdd-kit check (CI/local gate)"] --> SPECIFY
  CHECK --> PROMPTS
  CHECK --> AG
```

## Where Things Live (Layout)

```text
.sddkit/
  config.toml                  # sdd-kit config (manual)
  fragments/
    AGENTS.manual.md           # overlay for AGENTS.md MANUAL block (edit this)

.specify/                      # managed: Spec Kit templates/scripts (installed by sdd-kit)
  templates/
  scripts/
    bash/                      # sh scripts (mac/linux)
    powershell/                # ps scripts (windows)
  memory/
    constitution.md            # created if missing; user-editable
  THIRD_PARTY_NOTICES.md       # managed: upstream Spec Kit attribution

.codex/prompts/                # managed: Codex commands (speckit.*)
  speckit.specify.md
  speckit.plan.md
  speckit.tasks.md
  speckit.implement.md

specs/                         # NOT managed: per-feature artifacts (created by Spec Kit)
  001-feature-name/
    spec.md
    plan.md
    tasks.md
```

## Ownership and Drift Check Rules

- `.specify/templates/*`: managed by `sdd-kit` (copied from pinned Spec Kit). Drift-checked.
- `.specify/scripts/*`: managed by `sdd-kit`. Drift-checked.
- `.codex/prompts/speckit.*.md`: managed by `sdd-kit` (generated from pinned Spec Kit). Drift-checked.
- `.specify/memory/constitution.md`: yours. `sdd-kit` only creates it if missing.
- `specs/**`: feature artifacts. Not drift-checked.
- `AGENTS.md`: updated by Spec Kit (`update-agent-context.*`). `sdd-kit` only patches the MANUAL block.

### Important: `AGENTS.md`

Put local additions into:

- `.sddkit/fragments/AGENTS.manual.md`

`sdd-kit sync` patches only:

```text
<!-- MANUAL ADDITIONS START -->
...
<!-- MANUAL ADDITIONS END -->
```

This prevents “two tools fighting over the same file”.

## Developer Workflow (Step by Step)

### 0) After `git clone`

If the repo uses submodules:

```bash
git submodule update --init --recursive
```

### 1) Create a feature

Recommended: agent command `speckit.specify`.

Script-only (no agent):

```bash
bash .specify/scripts/bash/create-new-feature.sh "Short feature description"
```

Result:

- creates a branch like `001-feature-name`
- creates `specs/001-feature-name/spec.md`

### 2) Planning

Recommended: `speckit.plan`.

Script-only:

```bash
bash .specify/scripts/bash/setup-plan.sh
```

Result:

- creates/updates `specs/001-.../plan.md`
- (usually) updates `AGENTS.md` via `update-agent-context`

### 3) Tasks

Command: `speckit.tasks`.

Result:

- creates/updates `specs/001-.../tasks.md`

### 4) Implement

Command: `speckit.implement`.

Rules of thumb:

- Do one task at a time.
- Run real checks (tests/lint/build) frequently.
- If requirements change: update `spec.md/plan.md/tasks.md` before continuing.

### 5) Before PR: drift-check

```bash
python3 .tooling/sdd-workflow-kit/bin/sdd-kit check --project .
```

If you see `DRIFT/MISSING`:

```bash
python3 .tooling/sdd-workflow-kit/bin/sdd-kit sync --project .
python3 .tooling/sdd-workflow-kit/bin/sdd-kit check --project .
```

## Admin Guide

### Core commands

- `bootstrap`: create `.sddkit/config.toml` (if missing) and run `sync`
- `sync`: install/update managed files
- `check`: drift gate (CI)

### Safe mode

By default `safe_mode = true`.

- `sdd-kit` only edits files it previously marked as managed.
- If a file already exists but is not managed, it is skipped and reported as `UNMANAGED`.

### CI drift gate (GitHub Actions)

Critical in Spec Kit mode: checkout with `submodules: recursive`.

Typical CI command:

```bash
python3 .tooling/sdd-workflow-kit/bin/sdd-kit check --project . --config .sddkit/config.toml
```

### Updating `sdd-workflow-kit` in this repo

Recommended process:

1. Update the `.tooling/sdd-workflow-kit` submodule to a new tag.
2. `git submodule update --init --recursive`
3. `sync` and `check`
4. Commit: the submodule bump + updated managed files.

### Enabling Memory Bank (optional)

Memory Bank can be enabled alongside Spec Kit.

In `.sddkit/config.toml`:

```toml
[manage]
memory_bank = true
meta_tools = true
meta_sdd = true
```

Then:

```bash
python3 .tooling/sdd-workflow-kit/bin/sdd-kit sync --project .
```

## Troubleshooting

### `UNMANAGED ... (safe_mode)`

The file already exists and is not managed.

Options:

- rename/remove it, then run `sync` again
- disable managing that area in `[manage]`

### Spec Kit complains about branch naming

Spec Kit expects branches like `001-feature-name`. Use `speckit.specify`.

### Windows

Set `script_variant = "ps"` in `.sddkit/config.toml`, then `sync`.
