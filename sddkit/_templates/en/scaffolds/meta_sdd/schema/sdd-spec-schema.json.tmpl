{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$comment": "managed-by: sdd-workflow-kit (kit-version: {{kit_version}})",
  "title": "SDD Spec File Schema",
  "description": "Schema for SDD (Spec-Driven Development) JSON specification files",
  "type": "object",
  "required": [
    "spec_id",
    "generated",
    "last_updated",
    "hierarchy"
  ],
  "properties": {
    "spec_id": {
      "type": "string",
      "pattern": "^[\\w-]+-\\d{4}-\\d{2}-\\d{2}-\\d{3}$",
      "description": "Unique specification identifier: {feature}-{YYYY-MM-DD}-{nnn}"
    },
    "title": {
      "type": "string",
      "minLength": 1,
      "description": "Human-readable specification title"
    },
    "generated": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp when spec was generated"
    },
    "last_updated": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of last update"
    },
    "metadata": {
      "type": "object",
      "description": "Optional spec-level metadata",
      "properties": {
        "title": {
          "type": "string",
          "description": "Specification title retained for backward compatibility."
        },
        "description": {
          "type": "string",
          "description": "High-level description of the specification."
        },
        "objectives": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Key objectives or acceptance criteria for the spec."
        },
        "complexity": {
          "type": "string",
          "description": "Relative complexity indicator."
        },
        "estimated_hours": {
          "type": "number",
          "minimum": 0
        },
        "owner": {
          "type": "string"
        },
        "status": {
          "type": "string",
          "description": "Workflow status for the specification."
        },
        "assumptions": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Design assumptions and constraints for this spec (e.g., single-user workflow, feature branch ownership)"
        },
        "revision_history": {
          "type": "array",
          "items": {
            "type": "object",
            "required": [
              "version",
              "date",
              "changelog"
            ],
            "properties": {
              "version": {
                "type": "string",
                "description": "Version number (e.g., 1.0, 1.1, 2.0)"
              },
              "date": {
                "type": "string",
                "format": "date-time",
                "description": "ISO 8601 timestamp of revision"
              },
              "author": {
                "type": "string",
                "description": "Who made the revision"
              },
              "changelog": {
                "type": "string",
                "description": "Description of changes made in this revision"
              },
              "modified_by": {
                "type": "string",
                "description": "Tool or command that made the modification (e.g., sdd modify-spec)"
              },
              "review_triggered_by": {
                "type": "string",
                "description": "Path to review report that triggered this revision (if applicable)"
              }
            }
          },
          "description": "Version history tracking spec modifications over time"
        }
      },
      "additionalProperties": true
    },
    "hierarchy": {
      "type": "object",
      "description": "Task hierarchy tree",
      "patternProperties": {
        "^spec-root$": {
          "$ref": "#/definitions/node"
        },
        "^phase-\\d+(?:-[\\w-]+)*$": {
          "$ref": "#/definitions/node"
        },
        "^task-\\d+(?:-\\d+)+$": {
          "$ref": "#/definitions/node"
        },
        "^verify-\\d+(?:-\\d+)+$": {
          "$ref": "#/definitions/node"
        }
      }
    }
  },
  "definitions": {
    "node": {
      "type": "object",
      "required": [
        "type",
        "title",
        "status",
        "parent",
        "children",
        "total_tasks",
        "completed_tasks",
        "metadata"
      ],
      "properties": {
        "id": {
          "type": "string",
          "description": "Node identifier matching the key in hierarchy"
        },
        "type": {
          "type": "string",
          "enum": [
            "spec",
            "phase",
            "group",
            "task",
            "subtask",
            "verify"
          ],
          "description": "Node type in hierarchy"
        },
        "title": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable title"
        },
        "status": {
          "type": "string",
          "enum": [
            "pending",
            "in_progress",
            "completed",
            "blocked"
          ],
          "description": "Current status"
        },
        "parent": {
          "type": [
            "string",
            "null"
          ],
          "description": "Parent node ID (null only for spec-root)"
        },
        "children": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Array of child node IDs"
        },
        "metadata": {
          "type": "object",
          "description": "Node-specific metadata",
          "default": {},
          "properties": {
            "purpose": {
              "type": "string",
              "description": "High-level intent or goal for the node's work."
            },
            "risk_level": {
              "type": "string",
              "description": "Qualitative risk indicator (e.g., low, medium, high)."
            },
            "estimated_hours": {
              "type": "number",
              "minimum": 0
            },
            "complexity": {
              "type": "string",
              "description": "Relative complexity label."
            },
            "task_category": {
              "type": "string",
              "enum": [
                "investigation",
                "implementation",
                "refactoring",
                "decision",
                "research"
              ],
              "description": "Category of task work."
            },
            "file_path": {
              "type": "string",
              "description": "Primary file impacted by the node."
            },
            "details": {
              "oneOf": [
                {"type": "string"},
                {
                  "type": "array",
                  "items": {"type": "string"}
                }
              ],
              "description": "Free-form detail text for subtasks and tasks. Can be a string or array of strings."
            },
            "changes": {
              "type": "string",
              "description": "Summary of expected code or documentation changes."
            },
            "reasoning": {
              "type": "string",
              "description": "Supporting rationale or justification."
            },
            "owner": {
              "type": "string",
              "description": "Optional owner or assignee."
            },
            "verification_type": {
              "type": "string",
              "enum": [
                "auto",
                "manual",
                "fidelity"
              ]
            },
            "agent": {
              "type": "string",
              "description": "Automation agent to run for verification."
            },
            "command": {
              "type": "string",
              "description": "Command or instructions for automated verification."
            },
            "expected": {
              "type": "string",
              "description": "Expected outcome of verification."
            },
            "scope": {
              "type": "string",
              "description": "Scope identifier for fidelity verification."
            },
            "target": {
              "type": "string",
              "description": "Target identifier for verification scope."
            },
            "status": {
              "type": "string",
              "description": "Optional workflow status for metadata (distinct from node status)."
            },
            "started_at": {
              "type": "string",
              "format": "date-time",
              "description": "ISO 8601 timestamp when work started."
            },
            "completed_at": {
              "type": "string",
              "format": "date-time",
              "description": "ISO 8601 timestamp when work completed."
            },
            "actual_hours": {
              "type": "number",
              "minimum": 0,
              "description": "Actual hours spent on the node."
            },
            "on_failure": {
              "$ref": "#/definitions/on_failure_actions"
            }
          },
          "additionalProperties": true
        },
        "total_tasks": {
          "type": "integer",
          "minimum": 0,
          "description": "Total tasks in this subtree"
        },
        "completed_tasks": {
          "type": "integer",
          "minimum": 0,
          "description": "Completed tasks in this subtree"
        },
        "dependencies": {
          "type": "object",
          "properties": {
            "blocked_by": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "depends": {
              "type": "array",
              "items": {
                "type": "string"
              }
            },
            "blocks": {
              "type": "array",
              "items": {
                "type": "string"
              }
            }
          }
        }
      }
    },
    "on_failure_actions": {
      "type": "object",
      "description": "Configurable actions to take when verification fails",
      "properties": {
        "consult": {
          "type": "boolean",
          "description": "Whether to trigger AI consultation for debugging (default: false)",
          "default": false
        },
        "revert_status": {
          "type": "string",
          "enum": [
            "pending",
            "in_progress",
            "blocked"
          ],
          "description": "Status to revert the parent task to on failure (default: in_progress)",
          "default": "in_progress"
        },
        "max_retries": {
          "type": "integer",
          "minimum": 0,
          "maximum": 5,
          "description": "Maximum number of automatic retry attempts (default: 0)",
          "default": 0
        },
        "notify": {
          "type": "string",
          "enum": [
            "log"
          ],
          "description": "Notification method on failure (default: log)",
          "default": "log"
        },
        "continue_on_failure": {
          "type": "boolean",
          "description": "Whether to continue with other verifications if this one fails (default: false)",
          "default": false
        }
      },
      "additionalProperties": false
    }
  }
}
