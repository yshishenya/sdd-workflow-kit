# THIS IS AUTOGENERATED. DO NOT EDIT MANUALLY
# managed-by: sdd-workflow-kit (kit-version: {{kit_version}})
version = 1
name = "{{project_name}}"

[setup]
script = '''
set -euo pipefail

# Docker-first workflow:
# - do NOT create local .venv or install backend deps
# - do NOT run npm ci locally
# Everything runs via docker compose (see Actions below).

# Codex обычно запускает setup уже внутри worktree, но переменная $wt не всегда определена.
wt_dir="${wt:-$PWD}"
cd "$wt_dir"

# 1) .env: взять из основного checkout (если есть), иначе .env.example
main_repo="$(dirname "$(realpath "$(git rev-parse --git-common-dir)")")"
if [ ! -e .env ]; then
  if [ -f "$main_repo/.env" ]; then
    ln -s "$main_repo/.env" .env
  elif [ -f .env.example ]; then
    cp .env.example .env
  fi
fi

# No local dependency install here.
'''

[[actions]]
name = "docker: build airis (no-cache)"
icon = "code"
command = "cd \"${wt:-$PWD}\" && docker compose -f docker-compose.yaml -f docker-compose.dev.yaml build --no-cache airis"

[[actions]]
name = "docker: up"
icon = "play"
command = "cd \"${wt:-$PWD}\" && docker compose -f docker-compose.yaml -f docker-compose.dev.yaml up -d"

[[actions]]
name = "docker: restart"
icon = "refresh"
command = "cd \"${wt:-$PWD}\" && docker compose -f docker-compose.yaml -f docker-compose.dev.yaml restart"

[[actions]]
name = "docker: down (keep volumes)"
icon = "stop"
command = "cd \"${wt:-$PWD}\" && docker compose -f docker-compose.yaml -f docker-compose.dev.yaml down"

[[actions]]
name = "docker: logs (follow)"
icon = "terminal"
command = "cd \"${wt:-$PWD}\" && docker compose -f docker-compose.yaml -f docker-compose.dev.yaml logs -f --tail=200"

[[actions]]
name = "pytest (docker)"
icon = "test"
command = "cd \"${wt:-$PWD}\" && docker compose -f docker-compose.yaml -f docker-compose.dev.yaml run --rm airis bash -lc \"pytest\""

[[actions]]
name = "ruff (docker)"
icon = "test"
command = "cd \"${wt:-$PWD}\" && docker compose -f docker-compose.yaml -f docker-compose.dev.yaml -f .codex/docker-compose.codex.yaml run --rm --no-deps pytools \"python -m pip install -U pip >/dev/null && python -m pip install -q 'ruff>=0.1' && ruff check backend\""

[[actions]]
name = "mypy (docker)"
icon = "test"
command = "cd \"${wt:-$PWD}\" && docker compose -f docker-compose.yaml -f docker-compose.dev.yaml -f .codex/docker-compose.codex.yaml run --rm --no-deps pytools \"python -m pip install -U pip >/dev/null && python -m pip install -q 'mypy>=1.7' && mypy backend/open_webui --ignore-missing-imports\""

[[actions]]
name = "test:frontend (docker)"
icon = "test"
command = "cd \"${wt:-$PWD}\" && docker compose -f docker-compose.yaml -f docker-compose.dev.yaml run --rm --no-deps airis-frontend sh -lc \"if [ ! -e node_modules/.bin/vitest ]; then npm ci --legacy-peer-deps; fi; npm run test:frontend\""

[[actions]]
name = "test:e2e (docker)"
icon = "test"
command = "cd \"${wt:-$PWD}\" && docker compose -f docker-compose.yaml -f docker-compose.dev.yaml -f .codex/docker-compose.codex.yaml run --rm --no-deps e2e \"npm ci && npm run test:e2e\""
